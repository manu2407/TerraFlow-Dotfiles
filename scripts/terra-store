#!/bin/bash

# =========================================================
#  TERRA STORE v2.0 (Bash Edition)
#  Pre-authenticated, Silent Install, Native Performance
# =========================================================

# --- 1. CONFIGURATION ---
COLOR_BG="#1f2428"
COLOR_FG="#e1e4e8"
COLOR_ACCENT="#98c379"
COLOR_SEC="#d19a66"
BAT_THEME="OneHalfDark"

# --- 2. AUTHENTICATION (The "Pre-Consent" Logic) ---
# This loop ensures sudo never times out while you browse
authenticate() {
    # If we don't have sudo, ask for it using gum (masked input)
    if ! sudo -n true 2>/dev/null; then
        echo -e "\n:: Administrative privileges required."
        gum input --password --placeholder "Enter Sudo Password..." | sudo -S -v 2>/dev/null
        
        if [ $? -ne 0 ]; then
            gum style --foreground 196 "Authentication Failed."
            exit 1
        fi
    fi
    
    # Keep sudo alive in the background
    while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &
}

# --- 3. THE INTERFACE ---

authenticate # Ask for password ONCE, right now.

clear
echo -e "\n"
gum style \
    --border double --margin "1 2" --padding "1 2" --border-foreground 114 \
    "TERRA STORE | BASH ENGINE"

echo -e "Select your repository source:\n"
CHOICE=$(gum choose --cursor.foreground 114 "1. Official Repos (Fast/Stable)" "2. AUR (Community/Custom)")

if [[ -z "$CHOICE" ]]; then exit 0; fi

# --- 4. THE LOGIC ---

if [[ "$CHOICE" == *"Official"* ]]; then
    # MODE A: OFFICIAL
    TARGET=$(pacman -Slq | fzf \
        --prompt="SEARCH > " \
        --pointer="➜" \
        --marker="✓" \
        --color=bg+:$COLOR_BG,bg:$COLOR_BG,spinner:$COLOR_ACCENT,hl:$COLOR_SEC \
        --preview "pacman -Si {} | bat --color=always -l yaml --theme='$BAT_THEME'" \
        --preview-window=right:55%:wrap:border-left \
        --bind 'enter:accept' \
        --header "ENTER: Install (Auto-Confirm) | ESC: Quit")

    if [ -n "$TARGET" ]; then
        echo -e "\n\e[32m[TERRA]\e[0m Installing $TARGET..."
        # The --noconfirm flag makes it "Command and that's it"
        sudo pacman -S --noconfirm "$TARGET"
    fi

elif [[ "$CHOICE" == *"AUR"* ]]; then
    # MODE B: AUR
    echo ":: Loading AUR database..."
    TARGET=$(paru -Slq | fzf \
        --prompt="SEARCH AUR > " \
        --pointer="➜" \
        --color=bg+:$COLOR_BG,bg:$COLOR_BG,spinner:$COLOR_ACCENT,hl:$COLOR_SEC \
        --preview "paru -Si {} | bat --color=always -l yaml --theme='$BAT_THEME'" \
        --preview-window=right:55%:wrap:border-left \
        --header "ENTER: Install (Auto-Confirm) | ESC: Quit")

    if [ -n "$TARGET" ]; then
        echo -e "\n\e[32m[TERRA]\e[0m Building $TARGET..."
        # The --noconfirm flag makes it "Command and that's it"
        paru -S --noconfirm "$TARGET"
    fi
fi
